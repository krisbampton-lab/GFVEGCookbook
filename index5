<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GF Veg Cookbook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f7faf7;
      --bg-alt: #ffffff;
      --border: #d1e2d1;
      --accent: #2f7c4f;
      --accent-soft: #cfe8d7;
      --text: #1f2a1f;
      --muted: #5f6f5f;
      --card-shadow: 0 2px 6px rgba(0,0,0,0.06);
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 6px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 1rem 1.5rem;
      background: var(--bg-alt);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1.5rem;
      align-items: center;
      justify-content: space-between;
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .brand-title {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .brand-subtitle {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: flex-end;
    }

    .search-input {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.45rem 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg);
      min-width: 230px;
    }

    .search-input input {
      border: none;
      outline: none;
      background: transparent;
      font-size: 0.9rem;
      flex: 1;
    }

    select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.35rem 0.75rem;
      font-size: 0.9rem;
      background: var(--bg-alt);
      color: var(--text);
    }

    main {
      flex: 1;
      padding: 1.25rem 1.5rem 1rem;
    }

    .content-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.5fr);
      gap: 1rem;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .content-inner {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: var(--bg-alt);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
      padding: 0.9rem;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .panel-body {
      max-height: calc(100vh - 220px);
      overflow: auto;
      padding-right: 0.25rem;
    }

    @media (max-width: 900px) {
      .panel-body {
        max-height: none;
      }
    }

    .recipe-list {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .section-label {
      margin-top: 0.9rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      color: #2f7c4f;
      opacity: 0.8;
    }

    .recipe-card {
      border-radius: var(--radius-md);
      border: 1px solid #e1efe4;
      background: #f9fcf9;
      padding: 0.45rem 0.6rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
    }

    .recipe-card:hover {
      background: #f2f8f3;
      border-color: var(--accent-soft);
      transform: translateY(-1px);
    }

    .recipe-card.selected {
      border-color: var(--accent);
      background: #edf7ef;
    }

    .recipe-title {
      font-size: 0.92rem;
      font-weight: 600;
      color: #2f422f;
    }

    .recipe-meta {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .detail-header {
      margin-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.4rem;
    }

    .detail-title {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 0.1rem;
    }

    .detail-meta {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.15rem;
    }

    .detail-badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      font-size: 0.7rem;
    }

    .badge {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      color: var(--accent);
      background: #f3fbf5;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
    }

    .badge-type-main {
      background: #e8f5e9;
      border-color: #a5d6a7;
      color: #1b5e20;
    }

    .badge-type-soup {
      background: #e3f2fd;
      border-color: #90caf9;
      color: #0d47a1;
    }

    .badge-type-bowl {
      background: #fff3e0;
      border-color: #ffcc80;
      color: #e65100;
    }

    .badge-type-skillet {
      background: #f3e5f5;
      border-color: #ce93d8;
      color: #4a148c;
    }

    .badge-type-dessert {
      background: #fce4ec;
      border-color: #f8bbd0;
      color: #880e4f;
    }

    .cook-mode-toggle {
      font-size: 0.75rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f6faf7;
      padding: 0.2rem 0.6rem;
      cursor: pointer;
    }

    .cook-mode-toggle.active {
      border-color: var(--accent);
      background: #e4f5e8;
      color: var(--accent);
    }

    .detail-sections {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
      gap: 0.75rem;
    }

    @media (max-width: 900px) {
      .detail-sections {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .detail-block {
      border-radius: var(--radius-md);
      background: #f9fcf9;
      border: 1px solid #e0eee2;
      padding: 0.6rem 0.7rem;
      font-size: 0.87rem;
    }

    .detail-block h4 {
      margin: 0 0 0.35rem;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    .detail-block ul {
      margin: 0.2rem 0 0 1.2rem;
      padding: 0;
    }

    .detail-block li {
      margin-bottom: 0.15rem;
    }

    .detail-block ol {
      margin: 0.2rem 0 0 1.2rem;
      padding: 0;
    }

    .detail-block p {
      margin: 0.2rem 0;
    }

    .nutrition-note {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 0.45rem;
    }

    .empty-state {
      font-size: 0.85rem;
      color: var(--muted);
      padding: 0.75rem 0.25rem;
    }

    .error-state {
      font-size: 0.85rem;
      color: #b03030;
      padding: 0.75rem 0.25rem;
    }

    .importer-footer {
      border-top: 1px solid var(--border);
      padding: 0.5rem 1.5rem 1rem;
      background: #f5f8f6;
    }

    .importer-inner {
      max-width: 1200px;
      margin: 0 auto;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .importer-details {
      border-radius: var(--radius-md);
      border: 1px dashed var(--border);
      padding: 0.35rem 0.6rem 0.5rem;
      background: #f8fbf8;
    }

    .importer-details summary {
      cursor: pointer;
      list-style: none;
      font-weight: 500;
      color: #708270;
    }

    .importer-details summary::marker,
    .importer-details summary::-webkit-details-marker {
      display: none;
    }

    .importer-body {
      margin-top: 0.4rem;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 0.6rem;
    }

    @media (max-width: 800px) {
      .importer-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .importer-col label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.76rem;
    }

    .importer-col input[type="file"] {
      font-size: 0.75rem;
      width: 100%;
    }

    .importer-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      margin-top: 0.35rem;
    }

    .importer-btn {
      font-size: 0.76rem;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: #e5f5eb;
      color: var(--accent);
      padding: 0.25rem 0.7rem;
      cursor: pointer;
    }

    .importer-status {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .importer-status.error { color: #b03030; }
    .importer-status.success { color: #2f7c4f; }

    .tools-footer {
      border-top: 1px solid var(--border);
      padding: 1rem 1.5rem 1.2rem;
      background: #f7faf7;
    }

    .tools-inner {
      max-width: 1200px;
      margin: 0 auto;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .tools-inner details summary {
      cursor: pointer;
      font-weight: 600;
      color: #2f7c4f;
    }

    .tools-inner pre {
      white-space: pre;
      background: #ffffff;
      border: 1px solid #cfd8cf;
      padding: 0.7rem;
      border-radius: 8px;
      min-height: 80px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="header-inner">
        <div class="brand-block">
          <div class="brand-title">GF Veg Cookbook</div>
          <div class="brand-subtitle">
            High-protein, gluten-free vegetarian recipes ‚Äì powered by your JSON.
          </div>
        </div>
        <div class="controls-row">
          <div class="search-input">
            <span>üîç</span>
            <input id="searchInput" type="search" placeholder="Search recipes, ingredients, notes‚Ä¶" />
          </div>
          <select id="sectionFilter">
            <option value="">All sections</option>
          </select>
        </div>
      </div>
    </header>

    <main>
      <div class="content-inner">
        <section class="panel">
          <div class="panel-header">
            <div class="panel-title">Recipes</div>
            <div id="resultCount" class="panel-title" style="opacity:0.7;"></div>
          </div>
          <div class="panel-body">
            <div id="recipesList" class="recipe-list"></div>
            <div id="listMessage" class="empty-state" style="display:none;"></div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <div class="panel-title">Details</div>
            <button id="cookModeToggle" class="cook-mode-toggle" type="button">
              Cook Mode
            </button>
          </div>
          <div class="panel-body" id="detailBody">
            <div class="empty-state">
              Select a recipe on the left to see full ingredients, method, usage notes, and nutrition.
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="importer-footer">
      <div class="importer-inner">
        <details class="importer-details">
          <summary>
            <span>Advanced: Bulk importer (merge two recipe JSON files and download a combined file)</span>
          </summary>
          <div class="importer-body">
            <div class="importer-col">
              <label for="importExisting"><strong>1.</strong> Existing cookbook JSON (current <code>recipes.json</code>)</label>
              <input id="importExisting" type="file" accept="application/json" />
            </div>
            <div class="importer-col">
              <label for="importNew"><strong>2.</strong> New recipes JSON (extra recipes)</label>
              <input id="importNew" type="file" accept="application/json" />
            </div>
          </div>
          <div class="importer-actions">
            <button type="button" class="importer-btn" id="importMergeBtn">
              Merge &amp; Download merged_recipes.json
            </button>
            <div id="importStatus" class="importer-status">
              This never changes your live site automatically ‚Äì it just gives you a merged file to upload as your new <code>recipes.json</code>.
            </div>
          </div>
        </details>
      </div>
    </footer>

    <section class="tools-footer">
      <div class="tools-inner">
        <details>
          <summary>Tools (Export + Ingredient Meta Generator)</summary>
          <div style="margin-top:0.75rem;">

            <button onclick="downloadCookbook()"
              style="padding:0.4rem 0.9rem; border-radius:8px;
                     border:1px solid #2f7c4f; background:#e5f5eb; color:#2f7c4f;
                     margin-bottom:1rem; font-size:0.85rem;">
              ‚¨á Download Full Cookbook (recipes.json)
            </button>

            <div style="margin-bottom:0.5rem; font-weight:600;">Ingredient Meta Generator</div>

            <select id="metaIngId" style="flex:1; padding:0.3rem;">
  <option value="almond-milk">almond-milk</option>
  <option value="almonds">almonds</option>
  <option value="apple">apple</option>
  <option value="asparagus">asparagus</option>
  <option value="avocado">avocado</option>
  <option value="avocado-oil">avocado-oil</option>
  <option value="banana">banana</option>
  <option value="bbq-sauce">bbq-sauce</option>
  <option value="beetroot">beetroot</option>
  <option value="bell-pepper-red">bell-pepper-red</option>
  <option value="beyond-beef">beyond-beef</option>
  <option value="beyond-burger">beyond-burger</option>
  <option value="black-beans">black-beans</option>
  <option value="broccoli">broccoli</option>
  <option value="brussels-sprouts">brussels-sprouts</option>
  <option value="butternut-squash">butternut-squash</option>
  <option value="cabbage-green">cabbage-green</option>
  <option value="carrot">carrot</option>
  <option value="cauliflower">cauliflower</option>
  <option value="celery">celery</option>
  <option value="cheddar">cheddar</option>
  <option value="chickpeas">chickpeas</option>
  <option value="chili-garlic-sauce">chili-garlic-sauce</option>
  <option value="coconut-cream">coconut-cream</option>
  <option value="coconut-flakes">coconut-flakes</option>
  <option value="coconut-milk">coconut-milk</option>
  <option value="coconut-sugar">coconut-sugar</option>
  <option value="corn-kernel">corn-kernel</option>
  <option value="eggplant">eggplant</option>
  <option value="feta">feta</option>
  <option value="firm-tofu">firm-tofu</option>
  <option value="flaxseed-ground">flaxseed-ground</option>
  <option value="garlic">garlic</option>
  <option value="gf-pasta-shells">gf-pasta-shells</option>
  <option value="gf-puff-pastry">gf-puff-pastry</option>
  <option value="green-beans">green-beans</option>
  <option value="green-peas">green-peas</option>
  <option value="hoisin-gf">hoisin-gf</option>
  <option value="hot-sauce">hot-sauce</option>
  <option value="ketchup">ketchup</option>
  <option value="kidney-beans">kidney-beans</option>
  <option value="leek">leek</option>
  <option value="lemon-juice">lemon-juice</option>
  <option value="lentils-brown">lentils-brown</option>
  <option value="lime-juice">lime-juice</option>
  <option value="maple-syrup">maple-syrup</option>
  <option value="mushroom-brown">mushroom-brown</option>
  <option value="mustard-yellow">mustard-yellow</option>
  <option value="oat-milk">oat-milk</option>
  <option value="oats-rolled-dry">oats-rolled-dry</option>
  <option value="olive-oil">olive-oil</option>
  <option value="onion-yellow">onion-yellow</option>
  <option value="parmesan">parmesan</option>
  <option value="parsnip">parsnip</option>
  <option value="pasta-gf">pasta-gf</option>
  <option value="pecans">pecans</option>
  <option value="pistachios">pistachios</option>
  <option value="potato-white">potato-white</option>
  <option value="quinoa-cooked">quinoa-cooked</option>
  <option value="raisins">raisins</option>
  <option value="rice-cooked">rice-cooked</option>
  <option value="salsa-jar">salsa-jar</option>
  <option value="sesame-oil">sesame-oil</option>
  <option value="smoked-paprika">smoked-paprika</option>
  <option value="soy-crumble">soy-crumble</option>
  <option value="soy-sauce">soy-sauce</option>
  <option value="spinach">spinach</option>
  <option value="sugar-brown">sugar-brown</option>
  <option value="sugar-white">sugar-white</option>
  <option value="sunflower-seeds">sunflower-seeds</option>
  <option value="sweet-potato">sweet-potato</option>
  <option value="tahini">tahini</option>
  <option value="tahini-sauce">tahini-sauce</option>
  <option value="tempeh">tempeh</option>
  <option value="tomato-canned">tomato-canned</option>
  <option value="tomato-paste">tomato-paste</option>
  <option value="veg-mayo">veg-mayo</option>
  <option value="vegan-parmesan">vegan-parmesan</option>
  <option value="vegan-ricotta">vegan-ricotta</option>
  <option value="walnuts">walnuts</option>
  <option value="white-beans">white-beans</option>
  <option value="yogurt-greek-plain">yogurt-greek-plain</option>
  <option value="zucchini">zucchini</option>
</select>

              <input type="number" id="metaIngGrams" placeholder="grams"
                     style="width:90px; padding:0.3rem;">
              <button onclick="addMetaEntry()"
                      style="padding:0.3rem 0.8rem; border-radius:6px;
                             background:#edf7ef; border:1px solid #cfe8d7;">
                Add
              </button>
            </div>

            <pre id="metaGenOutput"></pre>

            <button onclick="copyMetaOutput()"
                    style="margin-top:0.5rem; padding:0.3rem 0.8rem;
                           border-radius:6px; background:#e5f5eb;
                           border:1px solid #2f7c4f;">
              Copy Meta Block
            </button>

          </div>
        </details>
      </div>
    </section>
  </div>

  <script>
    const RECIPES_JSON_URL = "recipes.json";

  // Approximate per-10g nutrition for core ingredients.
// kcal, protein(g), carbs(g), fat(g), satfat(g), fiber(g), sugars(g), sodium(mg), potassium(mg)
const NUTRITION_DB_10G = {
  // --- LEGUMES / PROTEIN BASES ---
  "firm-tofu":        { kcal: 8,  protein: 1.1, carbs: 0.2, fat: 0.5, satfat: 0.1, fiber: 0.1, sugars: 0.1, sodium: 3,   potassium: 12 },
  "tempeh":           { kcal: 10, protein: 1.8, carbs: 0.4, fat: 0.5, satfat: 0.1, fiber: 0.3, sugars: 0.1, sodium: 1,   potassium: 17 },
  "chickpeas":        { kcal: 12, protein: 0.6, carbs: 2.0, fat: 0.2, satfat: 0.0, fiber: 0.6, sugars: 0.1, sodium: 2,   potassium: 18 },
  "lentils":          { kcal: 11, protein: 0.9, carbs: 2.0, fat: 0.1, satfat: 0.0, fiber: 0.8, sugars: 0.1, sodium: 1,   potassium: 21 },
  "black-beans":      { kcal: 12, protein: 0.9, carbs: 2.0, fat: 0.1, satfat: 0.0, fiber: 0.8, sugars: 0.1, sodium: 2,   potassium: 18 },
  "kidney-beans":     { kcal: 12, protein: 0.9, carbs: 2.1, fat: 0.1, satfat: 0.0, fiber: 0.8, sugars: 0.1, sodium: 2,   potassium: 19 },
  "white-beans":      { kcal: 11, protein: 0.8, carbs: 2.0, fat: 0.1, satfat: 0.0, fiber: 0.7, sugars: 0.1, sodium: 2,   potassium: 18 },

  // --- ROOT VEGETABLES & SQUASHES ---
  "yam-orange":             { kcal: 12, protein: 0.2, carbs: 2.7, fat: 0.0, satfat: 0.0, fiber: 0.4, sugars: 0.7, sodium: 2,  potassium: 27 },
  "sweet-potato":           { kcal: 9,  protein: 0.1, carbs: 2.1, fat: 0.0, satfat: 0.0, fiber: 0.3, sugars: 0.9, sodium: 3,  potassium: 30 },
  "russet-potato":          { kcal: 8,  protein: 0.2, carbs: 1.9, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.1, sodium: 1,  potassium: 31 },
  "yellow-potato":          { kcal: 8,  protein: 0.2, carbs: 1.9, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.1, sodium: 1,  potassium: 30 },
  "red-potato":             { kcal: 8,  protein: 0.2, carbs: 1.7, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.1, sodium: 1,  potassium: 28 },
  "white-potato":           { kcal: 8,  protein: 0.2, carbs: 1.9, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.1, sodium: 1,  potassium: 30 },

  "pumpkin":                { kcal: 3,  protein: 0.1, carbs: 0.7, fat: 0.0, satfat: 0.0, fiber: 0.3, sugars: 0.3, sodium: 1,  potassium: 19 },
  "butternut-squash":       { kcal: 4,  protein: 0.1, carbs: 1.1, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.5, sodium: 1,  potassium: 28 },
  "acorn-squash":           { kcal: 4,  protein: 0.1, carbs: 1.1, fat: 0.0, satfat: 0.0, fiber: 0.3, sugars: 0.4, sodium: 1,  potassium: 23 },
  "spaghetti-squash":       { kcal: 3,  protein: 0.1, carbs: 0.7, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.3, sodium: 1,  potassium: 14 },
  "kabocha-squash":         { kcal: 5,  protein: 0.1, carbs: 1.2, fat: 0.0, satfat: 0.0, fiber: 0.3, sugars: 0.4, sodium: 1,  potassium: 27 },

  "parsnip":                { kcal: 7,  protein: 0.1, carbs: 1.7, fat: 0.0, satfat: 0.0, fiber: 0.5, sugars: 0.7, sodium: 2,  potassium: 28 },
  "turnip":                 { kcal: 3,  protein: 0.1, carbs: 0.7, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.4, sodium: 2,  potassium: 20 },
  "rutabaga":               { kcal: 3,  protein: 0.1, carbs: 0.8, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.4, sodium: 2,  potassium: 19 },
  "beetroot":               { kcal: 5,  protein: 0.1, carbs: 1.2, fat: 0.0, satfat: 0.0, fiber: 0.3, sugars: 0.9, sodium: 3,  potassium: 32 },

  "carrot":                 { kcal: 4,  protein: 0.1, carbs: 0.9, fat: 0.0, satfat: 0.0, fiber: 0.3, sugars: 0.5, sodium: 2,  potassium: 32 },
  "daikon-radish":          { kcal: 2,  protein: 0.0, carbs: 0.4, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.2, sodium: 1,  potassium: 18 },
  
  // --- CHEESE / DAIRY / ALT-DAIRY ---
  "halloumi":         { kcal: 32, protein: 2.2, carbs: 0.2, fat: 2.6, satfat: 1.7, fiber: 0.0, sugars: 0.0, sodium: 210, potassium: 7  },
  "cheddar":          { kcal: 40, protein: 2.5, carbs: 0.2, fat: 3.3, satfat: 2.1, fiber: 0.0, sugars: 0.0, sodium: 70,  potassium: 7  },
  "feta":             { kcal: 27, protein: 1.5, carbs: 0.4, fat: 2.2, satfat: 1.5, fiber: 0.0, sugars: 0.0, sodium: 110, potassium: 5  },
  "parmesan":         { kcal: 43, protein: 4.0, carbs: 0.4, fat: 3.0, satfat: 2.0, fiber: 0.0, sugars: 0.0, sodium: 80,  potassium: 10 },
  "yogurt-greek-plain":   { kcal: 6,  protein: 0.6, carbs: 0.4, fat: 0.2, satfat: 0.1, fiber: 0.0, sugars: 0.4, sodium: 4,  potassium: 14 },
  "yogurt-coconut-plain": { kcal: 15, protein: 0.1, carbs: 0.9, fat: 1.3, satfat: 1.1, fiber: 0.1, sugars: 0.5, sodium: 3,  potassium: 6  },
  "butter":           { kcal: 72, protein: 0.0, carbs: 0.0, fat: 8.0, satfat: 5.0, fiber: 0.0, sugars: 0.0, sodium: 1,   potassium: 1  },

  // --- OILS / FATS ---
  "olive-oil":        { kcal: 88, protein: 0.0, carbs: 0.0, fat: 10.0, satfat: 1.4, fiber: 0.0, sugars: 0.0, sodium: 0,  potassium: 0  },
  "canola-oil":       { kcal: 88, protein: 0.0, carbs: 0.0, fat: 10.0, satfat: 0.7, fiber: 0.0, sugars: 0.0, sodium: 0,  potassium: 0  },
  "coconut-milk":     { kcal: 18, protein: 0.2, carbs: 0.2, fat: 1.8, satfat: 1.6, fiber: 0.1, sugars: 0.1, sodium: 2,   potassium: 16 },

  // --- GRAINS / STARCHES ---
  "rice-cooked":      { kcal: 13, protein: 0.3, carbs: 2.9, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.0, sodium: 0,   potassium: 1  },
  "pasta-gf":         { kcal: 14, protein: 0.5, carbs: 2.9, fat: 0.1, satfat: 0.0, fiber: 0.2, sugars: 0.0, sodium: 0,   potassium: 1  },
  "quinoa-cooked":    { kcal: 12, protein: 0.4, carbs: 2.1, fat: 0.2, satfat: 0.0, fiber: 0.2, sugars: 0.0, sodium: 1,   potassium: 7  },
  "oats-rolled-dry":  { kcal: 38, protein: 1.3, carbs: 6.5, fat: 0.7, satfat: 0.1, fiber: 1.0, sugars: 0.2, sodium: 1,   potassium: 33 },
  "sweet-potato":     { kcal: 9,  protein: 0.1, carbs: 2.1, fat: 0.0, satfat: 0.0, fiber: 0.3, sugars: 0.9, sodium: 3,   potassium: 30 },
  "potato-white":     { kcal: 8,  protein: 0.2, carbs: 1.9, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.1, sodium: 1,   potassium: 30 },
  "corn-kernel":      { kcal: 10, protein: 0.3, carbs: 2.0, fat: 0.1, satfat: 0.0, fiber: 0.3, sugars: 0.6, sodium: 1,   potassium: 10 },

  // --- NUTS / SEEDS / SPREADS ---
  "almonds":          { kcal: 58, protein: 2.1, carbs: 2.0, fat: 5.0, satfat: 0.4, fiber: 1.2, sugars: 0.5, sodium: 0,   potassium: 70 },
  "cashews":          { kcal: 55, protein: 1.8, carbs: 3.0, fat: 4.4, satfat: 0.9, fiber: 0.3, sugars: 1.0, sodium: 3,   potassium: 60 },
  "peanut-butter":    { kcal: 59, protein: 2.5, carbs: 2.0, fat: 4.9, satfat: 1.0, fiber: 0.8, sugars: 0.8, sodium: 47,  potassium: 70 },
  "tahini":           { kcal: 59, protein: 1.8, carbs: 1.7, fat: 5.3, satfat: 0.7, fiber: 0.9, sugars: 0.1, sodium: 3,   potassium: 45 },
  "chia-seeds":       { kcal: 49, protein: 1.6, carbs: 4.2, fat: 3.1, satfat: 0.3, fiber: 4.0, sugars: 0.0, sodium: 2,   potassium: 33 },
  "hemp-seeds":       { kcal: 55, protein: 3.2, carbs: 0.4, fat: 4.8, satfat: 0.5, fiber: 0.5, sugars: 0.0, sodium: 0,   potassium: 45 },
  "pumpkin-seeds":    { kcal: 56, protein: 3.0, carbs: 1.6, fat: 4.6, satfat: 0.9, fiber: 0.9, sugars: 0.2, sodium: 1,   potassium: 60 },

  // --- VEG & AROMATICS ---
  "onion-yellow":     { kcal: 4,  protein: 0.1, carbs: 0.9, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.4, sodium: 1,   potassium: 14 },
  "garlic":           { kcal: 15, protein: 0.6, carbs: 3.0, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.1, sodium: 1,   potassium: 36 },
  "carrot":           { kcal: 4,  protein: 0.1, carbs: 0.9, fat: 0.0, satfat: 0.0, fiber: 0.3, sugars: 0.5, sodium: 2,   potassium: 32 },
  "celery":           { kcal: 2,  protein: 0.1, carbs: 0.3, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.2, sodium: 10,  potassium: 20 },
  "bell-pepper-red":  { kcal: 3,  protein: 0.1, carbs: 0.7, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.4, sodium: 1,   potassium: 20 },
  "bell-pepper-green":{ kcal: 2,  protein: 0.1, carbs: 0.6, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.3, sodium: 1,   potassium: 18 },
  "zucchini":         { kcal: 2,  protein: 0.1, carbs: 0.4, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.3, sodium: 1,   potassium: 16 },
  "tomato-fresh":     { kcal: 2,  protein: 0.1, carbs: 0.4, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.3, sodium: 1,   potassium: 24 },
  "tomato-canned":    { kcal: 2,  protein: 0.1, carbs: 0.4, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.3, sodium: 3,   potassium: 25 },
  "cabbage-green":    { kcal: 2,  protein: 0.1, carbs: 0.4, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.2, sodium: 2,   potassium: 18 },
  "kale":             { kcal: 3,  protein: 0.3, carbs: 0.5, fat: 0.1, satfat: 0.0, fiber: 0.3, sugars: 0.2, sodium: 5,   potassium: 30 },
  "leek":             { kcal: 3,  protein: 0.1, carbs: 0.7, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.3, sodium: 2,   potassium: 15 },
  "mushroom-brown":   { kcal: 2,  protein: 0.3, carbs: 0.4, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.2, sodium: 2,   potassium: 28 },
  "broccoli":         { kcal: 3,  protein: 0.3, carbs: 0.5, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.1, sodium: 2,   potassium: 26 },
  "spinach":          { kcal: 2,  protein: 0.3, carbs: 0.3, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.0, sodium: 6,   potassium: 28 },

  // --- SAUCES / FLAVOUR BASES ---
  "tamari-gf":        { kcal: 5,  protein: 0.9, carbs: 0.5, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.1, sodium: 550, potassium: 20 },
  "soy-sauce":        { kcal: 5,  protein: 0.9, carbs: 0.5, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.1, sodium: 550, potassium: 20 },
  "sriracha":         { kcal: 3,  protein: 0.0, carbs: 0.7, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 0.5, sodium: 40,  potassium: 6  },
  "maple-syrup":      { kcal: 26, protein: 0.0, carbs: 6.8, fat: 0.0, satfat: 0.0, fiber: 0.0, sugars: 6.6, sodium: 1,   potassium: 4  },
  "honey":            { kcal: 30, protein: 0.0, carbs: 8.1, fat: 0.0, satfat: 0.0, fiber: 0.0, sugars: 8.1, sodium: 1,   potassium: 5  },
  "vinegar-apple-cider": { kcal: 0, protein: 0.0, carbs: 0.0, fat: 0.0, satfat: 0.0, fiber: 0.0, sugars: 0.0, sodium: 0, potassium: 0  },
  "miso-paste":       { kcal: 20, protein: 1.2, carbs: 2.5, fat: 0.6, satfat: 0.1, fiber: 0.3, sugars: 1.0, sodium: 370, potassium: 30 },
  "nutritional-yeast":{ kcal: 35, protein: 5.0, carbs: 3.5, fat: 0.5, satfat: 0.1, fiber: 2.0, sugars: 0.0, sodium: 5,   potassium: 50 },

  // --- FRUITS ---
  "banana":              { kcal: 9,  protein: 0.1, carbs: 2.3, fat: 0.0, satfat: 0.0, fiber: 0.3, sugars: 1.4, sodium: 0,  potassium: 36 },
  "apple":               { kcal: 5,  protein: 0.0, carbs: 1.4, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 1.1, sodium: 0,  potassium: 6  },
  "pear":                { kcal: 6,  protein: 0.0, carbs: 1.6, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 1.3, sodium: 0,  potassium: 7  },
  "orange":              { kcal: 5,  protein: 0.1, carbs: 1.3, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 1.1, sodium: 0,  potassium: 13 },
  "lemon-juice":         { kcal: 3,  protein: 0.0, carbs: 1.0, fat: 0.0, satfat: 0.0, fiber: 0.0, sugars: 0.3, sodium: 0,  potassium: 5  },
  "lime-juice":          { kcal: 3,  protein: 0.0, carbs: 1.0, fat: 0.0, satfat: 0.0, fiber: 0.0, sugars: 0.3, sodium: 0,  potassium: 4  },
  "mango":               { kcal: 6,  protein: 0.1, carbs: 1.5, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 1.3, sodium: 0,  potassium: 7  },
  "pineapple":           { kcal: 5,  protein: 0.0, carbs: 1.3, fat: 0.0, satfat: 0.0, fiber: 0.1, sugars: 1.0, sodium: 0,  potassium: 4  },
  "strawberries":        { kcal: 3,  protein: 0.1, carbs: 0.7, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 0.4, sodium: 0,  potassium: 7  },
  "blueberries":         { kcal: 6,  protein: 0.1, carbs: 1.5, fat: 0.0, satfat: 0.0, fiber: 0.2, sugars: 1.1, sodium: 0,  potassium: 5  },
  "raspberries":         { kcal: 5,  protein: 0.1, carbs: 1.2, fat: 0.0, satfat: 0.0, fiber: 0.3, sugars: 0.5, sodium: 0,  potassium: 7  },
  "dates-medjool":       { kcal: 28, protein: 0.2, carbs: 7.5, fat: 0.0, satfat: 0.0, fiber: 0.8, sugars: 6.5, sodium: 1,  potassium: 65 },
  "raisins":             { kcal: 30, protein: 0.3, carbs: 7.9, fat: 0.0, satfat: 0.0, fiber: 0.4, sugars: 7.3, sodium: 2,  potassium: 75 },

  // --- SPICES, HERBS & SEASONINGS ---
  "garlic-powder":       { kcal: 33, protein: 1.6, carbs: 7.4, fat: 0.0, satfat: 0.0, fiber: 0.5, sugars: 0.3, sodium: 5,   potassium: 40 },
  "onion-powder":        { kcal: 34, protein: 1.0, carbs: 7.9, fat: 0.1, satfat: 0.0, fiber: 0.7, sugars: 2.3, sodium: 5,   potassium: 30 },

  "paprika":             { kcal: 29, protein: 1.4, carbs: 6.0, fat: 0.9, satfat: 0.1, fiber: 3.4, sugars: 0.8, sodium: 5,   potassium: 80 },
  "smoked-paprika":      { kcal: 29, protein: 1.4, carbs: 6.0, fat: 0.9, satfat: 0.1, fiber: 3.4, sugars: 0.8, sodium: 5,   potassium: 80 },
  "cumin-ground":        { kcal: 38, protein: 1.8, carbs: 4.6, fat: 1.9, satfat: 0.2, fiber: 2.2, sugars: 0.1, sodium: 8,   potassium: 80 },
  "coriander-ground":    { kcal: 30, protein: 1.3, carbs: 5.5, fat: 0.7, satfat: 0.1, fiber: 3.3, sugars: 0.1, sodium: 5,   potassium: 66 },
  "chili-powder":        { kcal: 29, protein: 1.3, carbs: 5.3, fat: 1.2, satfat: 0.2, fiber: 2.6, sugars: 0.8, sodium: 80,  potassium: 70 },
  "curry-powder":        { kcal: 28, protein: 1.2, carbs: 4.4, fat: 1.3, satfat: 0.4, fiber: 2.4, sugars: 0.3, sodium: 15,  potassium: 70 },
  "turmeric-ground":     { kcal: 31, protein: 0.9, carbs: 6.5, fat: 0.7, satfat: 0.2, fiber: 2.1, sugars: 0.2, sodium: 2,   potassium: 70 },

  "ginger-fresh":        { kcal: 8,  protein: 0.2, carbs: 1.8, fat: 0.1, satfat: 0.0, fiber: 0.2, sugars: 0.3, sodium: 2,   potassium: 37 },
  "ginger-ground":       { kcal: 33, protein: 0.9, carbs: 7.2, fat: 0.4, satfat: 0.1, fiber: 1.7, sugars: 0.3, sodium: 4,   potassium: 40 },
  "black-pepper":        { kcal: 25, protein: 1.0, carbs: 6.4, fat: 0.3, satfat: 0.1, fiber: 2.6, sugars: 0.1, sodium: 2,   potassium: 40 },
  "cinnamon-ground":     { kcal: 25, protein: 0.4, carbs: 8.1, fat: 0.1, satfat: 0.0, fiber: 5.4, sugars: 0.2, sodium: 1,   potassium: 45 },

 "herbs-mixed-dry":     { kcal: 27, protein: 2.5, carbs: 3.4, fat: 0.5, satfat: 0.1, fiber: 2.6, sugars: 0.2, sodium: 15,  potassium: 70 },

// High-sodium bases
 "table-salt":          { kcal: 0,  protein: 0.0, carbs: 0.0, fat: 0.0, satfat: 0.0, fiber: 0.0, sugars: 0.0, sodium: 3870, potassium: 0 },
 "veg-stock-paste":     { kcal: 9,  protein: 0.4, carbs: 1.2, fat: 0.3, satfat: 0.1, fiber: 0.1, sugars: 0.2, sodium: 700, potassium: 30 },
 "veg-stock-cube":      { kcal: 9,  protein: 0.4, carbs: 1.2, fat: 0.3, satfat: 0.1, fiber: 0.1, sugars: 0.2, sodium: 900, potassium: 30 }
  // --- EXTRA PLANT PROTEINS / MEAT ALTERNATIVES ---
  "beyond-beef": {
    kcal: 23, protein: 1.8, carbs: 0.4, fat: 1.6, satfat: 0.2,
    fiber: 0.2, sugars: 0.0, sodium: 31, potassium: 37
  },
  "beyond-burger": {
    kcal: 22, protein: 2.0, carbs: 0.7, fat: 1.3, satfat: 0.2,
    fiber: 0.2, sugars: 0.0, sodium: 26, potassium: 45
  },
  "soy-crumble": {
    kcal: 15, protein: 2.0, carbs: 1.0, fat: 0.4, satfat: 0.1,
    fiber: 0.6, sugars: 0.2, sodium: 39, potassium: 66
  },
  "lentils-brown": {
    kcal: 11, protein: 0.9, carbs: 2.0, fat: 0.1, satfat: 0.0,
    fiber: 0.8, sugars: 0.1, sodium: 1, potassium: 21
  },

  // --- EXTRA VEG / LEGUMES ---
  "cauliflower": {
    kcal: 2, protein: 0.2, carbs: 0.5, fat: 0.0, satfat: 0.0,
    fiber: 0.2, sugars: 0.2, sodium: 3, potassium: 30
  },
  "green-beans": {
    kcal: 3, protein: 0.2, carbs: 0.7, fat: 0.0, satfat: 0.0,
    fiber: 0.3, sugars: 0.3, sodium: 1, potassium: 30
  },
  "eggplant": {
    kcal: 2, protein: 0.1, carbs: 0.5, fat: 0.0, satfat: 0.0,
    fiber: 0.2, sugars: 0.3, sodium: 0, potassium: 10
  },
  "green-peas": {
    kcal: 8, protein: 0.5, carbs: 1.4, fat: 0.1, satfat: 0.0,
    fiber: 0.4, sugars: 0.5, sodium: 0, potassium: 25
  },
  "brussels-sprouts": {
    kcal: 4, protein: 0.3, carbs: 0.8, fat: 0.1, satfat: 0.0,
    fiber: 0.3, sugars: 0.4, sodium: 2, potassium: 33
  },
  "asparagus": {
    kcal: 2, protein: 0.2, carbs: 0.4, fat: 0.0, satfat: 0.0,
    fiber: 0.2, sugars: 0.2, sodium: 1, potassium: 20
  },
  "avocado": {
    kcal: 16, protein: 0.2, carbs: 0.8, fat: 1.5, satfat: 0.2,
    fiber: 0.7, sugars: 0.1, sodium: 1, potassium: 48
  },

  // --- EXTRA GRAINS / STARCHES ---
  "gf-pasta-shells": {
    kcal: 14, protein: 0.5, carbs: 2.9, fat: 0.1, satfat: 0.0,
    fiber: 0.2, sugars: 0.0, sodium: 0, potassium: 1
  },
  "gf-puff-pastry": {
    kcal: 55, protein: 0.6, carbs: 4.5, fat: 4.0, satfat: 2.0,
    fiber: 0.2, sugars: 0.3, sodium: 50, potassium: 6
  },

  // --- EXTRA NUTS / SEEDS ---
  "walnuts": {
    kcal: 65, protein: 1.5, carbs: 1.4, fat: 6.5, satfat: 0.6,
    fiber: 0.7, sugars: 0.2, sodium: 0, potassium: 45
  },
  "pecans": {
    kcal: 70, protein: 1.0, carbs: 1.4, fat: 7.3, satfat: 0.6,
    fiber: 1.0, sugars: 0.2, sodium: 0, potassium: 35
  },
  "pistachios": {
    kcal: 56, protein: 2.0, carbs: 2.8, fat: 4.5, satfat: 0.5,
    fiber: 1.1, sugars: 0.8, sodium: 1, potassium: 29
  },
  "sunflower-seeds": {
    kcal: 58, protein: 2.1, carbs: 2.1, fat: 4.9, satfat: 0.5,
    fiber: 1.1, sugars: 0.3, sodium: 1, potassium: 60
  },
  "flaxseed-ground": {
    kcal: 53, protein: 1.9, carbs: 2.9, fat: 4.2, satfat: 0.4,
    fiber: 2.7, sugars: 0.2, sodium: 3, potassium: 60
  },
  "coconut-flakes": {
    kcal: 66, protein: 0.7, carbs: 2.3, fat: 6.4, satfat: 5.5,
    fiber: 1.8, sugars: 1.0, sodium: 3, potassium: 40
  },

  // --- EXTRA SWEETENERS ---
  "sugar-white": {
    kcal: 39, protein: 0.0, carbs: 10.0, fat: 0.0, satfat: 0.0,
    fiber: 0.0, sugars: 10.0, sodium: 0, potassium: 0
  },
  "sugar-brown": {
    kcal: 38, protein: 0.0, carbs: 9.8, fat: 0.0, satfat: 0.0,
    fiber: 0.0, sugars: 9.8, sodium: 2, potassium: 2
  },
  "coconut-sugar": {
    kcal: 38, protein: 0.0, carbs: 9.5, fat: 0.0, satfat: 0.0,
    fiber: 0.0, sugars: 9.0, sodium: 3, potassium: 3
  },

  // --- EXTRA SAUCES / CONDIMENTS ---
  "ketchup": {
    kcal: 11, protein: 0.1, carbs: 2.7, fat: 0.0, satfat: 0.0,
    fiber: 0.1, sugars: 2.4, sodium: 100, potassium: 30
  },
  "mustard-yellow": {
    kcal: 7, protein: 0.4, carbs: 0.5, fat: 0.4, satfat: 0.0,
    fiber: 0.3, sugars: 0.1, sodium: 55, potassium: 8
  },
  "veg-mayo": {
    kcal: 70, protein: 0.0, carbs: 0.6, fat: 7.5, satfat: 1.0,
    fiber: 0.0, sugars: 0.3, sodium: 80, potassium: 2
  },
  "bbq-sauce": {
    kcal: 25, protein: 0.2, carbs: 6.0, fat: 0.1, satfat: 0.0,
    fiber: 0.2, sugars: 5.0, sodium: 180, potassium: 30
  },
  "hot-sauce": {
    kcal: 3, protein: 0.1, carbs: 0.6, fat: 0.0, satfat: 0.0,
    fiber: 0.1, sugars: 0.1, sodium: 120, potassium: 10
  },
  "tahini-sauce": {
    kcal: 45, protein: 1.3, carbs: 1.3, fat: 4.1, satfat: 0.6,
    fiber: 0.7, sugars: 0.2, sodium: 60, potassium: 35
  },
  "chili-garlic-sauce": {
    kcal: 12, protein: 0.3, carbs: 2.2, fat: 0.3, satfat: 0.0,
    fiber: 0.5, sugars: 1.0, sodium: 150, potassium: 20
  },
  "hoisin-gf": {
    kcal: 33, protein: 0.7, carbs: 7.7, fat: 0.4, satfat: 0.1,
    fiber: 0.3, sugars: 6.8, sodium: 260, potassium: 30
  },

  // --- EXTRA OILS / MILKS ---
  "sesame-oil": {
    kcal: 90, protein: 0.0, carbs: 0.0, fat: 10.0, satfat: 1.4,
    fiber: 0.0, sugars: 0.0, sodium: 0, potassium: 0
  },
  "avocado-oil": {
    kcal: 90, protein: 0.0, carbs: 0.0, fat: 10.0, satfat: 1.5,
    fiber: 0.0, sugars: 0.0, sodium: 0, potassium: 0
  },
  "oat-milk": {
    kcal: 5, protein: 0.1, carbs: 0.8, fat: 0.2, satfat: 0.0,
    fiber: 0.1, sugars: 0.4, sodium: 5, potassium: 10
  },
  "almond-milk": {
    kcal: 3, protein: 0.1, carbs: 0.3, fat: 0.3, satfat: 0.0,
    fiber: 0.1, sugars: 0.1, sodium: 5, potassium: 8
  },
  "coconut-cream": {
    kcal: 35, protein: 0.3, carbs: 0.4, fat: 3.6, satfat: 3.2,
    fiber: 0.2, sugars: 0.3, sodium: 3, potassium: 20
  },

  // --- EXTRA TOMATO / SALSA BASES ---
  "tomato-paste": {
    kcal: 12, protein: 0.5, carbs: 2.7, fat: 0.0, satfat: 0.0,
    fiber: 0.7, sugars: 1.5, sodium: 12, potassium: 75
  },
  "salsa-jar": {
    kcal: 5, protein: 0.2, carbs: 1.2, fat: 0.0, satfat: 0.0,
    fiber: 0.3, sugars: 0.6, sodium: 120, potassium: 40
  },

  // --- EXTRA VEGAN CHEESES ---
  "vegan-parmesan": {
    kcal: 44, protein: 1.0, carbs: 2.6, fat: 3.2, satfat: 2.0,
    fiber: 0.4, sugars: 0.0, sodium: 110, potassium: 20
  },
  "vegan-ricotta": {
    kcal: 26, protein: 0.9, carbs: 0.7, fat: 2.1, satfat: 0.4,
    fiber: 0.2, sugars: 0.1, sodium: 32, potassium: 40
  }

};

    function round1(x) { return Math.round(x * 10) / 10; }

    function inferServings(metaStr) {
      if (!metaStr) return 4;
      const m = /Serves\s+(\d+)/i.exec(metaStr);
      if (!m) return 4;
      const n = parseInt(m[1], 10);
      return Number.isFinite(n) && n > 0 ? n : 4;
    }

    function computeAutoNutrition(recipe) {
      const meta = recipe.ingredients_meta;
      if (!meta || !meta.length) return null;

      const totals = {
        kcal: 0, protein: 0, carbs: 0, fat: 0,
        satfat: 0, fiber: 0, sugars: 0, sodium: 0, potassium: 0
      };

      for (const item of meta) {
        if (!item || !item.id || !item.grams) continue;
        const db = NUTRITION_DB_10G[item.id];
        if (!db) continue;
        const blocks = item.grams / 10;
        totals.kcal      += db.kcal      * blocks;
        totals.protein   += db.protein   * blocks;
        totals.carbs     += db.carbs     * blocks;
        totals.fat       += db.fat       * blocks;
        totals.satfat    += db.satfat    * blocks;
        totals.fiber     += db.fiber     * blocks;
        totals.sugars    += db.sugars    * blocks;
        totals.sodium    += db.sodium    * blocks;
        totals.potassium += db.potassium * blocks;
      }

      const servings = inferServings(recipe.meta);
      return {
        servings,
        per: {
          kcal:      round1(totals.kcal      / servings),
          protein:   round1(totals.protein   / servings),
          carbs:     round1(totals.carbs     / servings),
          fat:       round1(totals.fat       / servings),
          satfat:    round1(totals.satfat    / servings),
          fiber:     round1(totals.fiber     / servings),
          sugars:    round1(totals.sugars    / servings),
          sodium:    Math.round(totals.sodium    / servings),
          potassium: Math.round(totals.potassium / servings)
        }
      };
    }

    function buildAutoNutritionHtml(recipe) {
      const result = computeAutoNutrition(recipe);
      if (!result) return null;
      const n = result.per;
      return `
<h4>Nutrition (auto-calculated, approx, per serving)</h4>
<ul>
  <li>Calories: ${n.kcal} kcal</li>
  <li>Protein: ${n.protein} g</li>
  <li>Carbohydrates: ${n.carbs} g</li>
  <li>Fat: ${n.fat} g</li>
  <li>Saturated Fat: ${n.satfat} g</li>
  <li>Fiber: ${n.fiber} g</li>
  <li>Sugars: ${n.sugars} g</li>
  <li>Sodium: ${n.sodium} mg</li>
  <li>Potassium: ${n.potassium} mg</li>
</ul>
<p>Calculated from ingredient estimates in this recipe. Values are approximate.</p>
`;
    }

    let allRecipes = [];
    let filteredRecipes = [];
    let selectedId = null;
    let cookMode = false;

    const searchInput = document.getElementById("searchInput");
    const sectionFilter = document.getElementById("sectionFilter");
    const recipesListEl = document.getElementById("recipesList");
    const listMessageEl = document.getElementById("listMessage");
    const detailBodyEl = document.getElementById("detailBody");
    const resultCountEl = document.getElementById("resultCount");
    const cookModeToggle = document.getElementById("cookModeToggle");

    async function loadRecipes() {
      try {
        const res = await fetch(RECIPES_JSON_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Network error loading recipes.json");
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("recipes.json is not an array");
        allRecipes = data;
        buildSectionFilter(allRecipes);
        filteredRecipes = [...allRecipes];
        renderRecipeList();
        updateResultCount();
      } catch (err) {
        console.error(err);
        recipesListEl.innerHTML = "";
        listMessageEl.style.display = "block";
        listMessageEl.className = "error-state";
        listMessageEl.textContent =
          "Could not load recipes.json. Check that the file exists next to index.html.";
      }
    }

    function buildSectionFilter(recipes) {
      const sections = Array.from(new Set(recipes.map(r => r.section || "")))
        .filter(Boolean)
        .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: "base" }));
      sectionFilter.innerHTML = '<option value="">All sections</option>';
      sections.forEach(sec => {
        const opt = document.createElement("option");
        opt.value = sec;
        opt.textContent = sec;
        sectionFilter.appendChild(opt);
      });
    }

    function applyFilters() {
      const term = searchInput.value.trim().toLowerCase();
      const section = sectionFilter.value;

      filteredRecipes = allRecipes.filter(r => {
        if (section && r.section !== section) return false;
        if (!term) return true;
        const haystack =
          (r.title || "") + " " +
          (r.section || "") + " " +
          (r.meta || "") + " " +
          (r.ingredients_html || "") + " " +
          (r.usage_html || "");
        return haystack.toLowerCase().includes(term);
      });

      if (selectedId && !filteredRecipes.some(r => r.id === selectedId)) {
        selectedId = null;
        renderRecipeDetail(null);
      }

      renderRecipeList();
      updateResultCount();
    }

    function updateResultCount() {
      const total = allRecipes.length;
      const shown = filteredRecipes.length;
      if (!total) {
        resultCountEl.textContent = "";
        return;
      }
      resultCountEl.textContent = `${shown} of ${total}`;
    }

    function renderRecipeList() {
      recipesListEl.innerHTML = "";
      listMessageEl.style.display = "none";

      if (!filteredRecipes.length) {
        listMessageEl.style.display = "block";
        listMessageEl.className = "empty-state";
        listMessageEl.textContent = "No recipes match your search or filters.";
        return;
      }

      const bySection = {};
      filteredRecipes.forEach(r => {
        const sec = r.section || "Uncategorized";
        if (!bySection[sec]) bySection[sec] = [];
        bySection[sec].push(r);
      });

      const sectionNames = Object.keys(bySection).sort((a, b) =>
        a.localeCompare(b, undefined, { sensitivity: "base" })
      );

      sectionNames.forEach(sec => {
        const label = document.createElement("div");
        label.className = "section-label";
        label.textContent = sec;
        recipesListEl.appendChild(label);

        bySection[sec].forEach(recipe => {
          const card = document.createElement("div");
          card.className =
            "recipe-card" + (recipe.id === selectedId ? " selected" : "");
          card.dataset.id = recipe.id;

          const titleEl = document.createElement("div");
          titleEl.className = "recipe-title";

          const titleLower = (recipe.title || "").toLowerCase();
          let icon = "üçΩ";
          const secLower = sec.toLowerCase();
          if (secLower.includes("soup") || titleLower.includes("soup") || titleLower.includes("stew")) icon = "ü•£";
          else if (titleLower.includes("bowl")) icon = "üç≤";
          else if (titleLower.includes("skillet")) icon = "üç≥";
          else if (secLower.includes("dessert") || titleLower.includes("cake") || titleLower.includes("cookie")) icon = "üç∞";

          titleEl.textContent = icon + " " + (recipe.title || "Untitled recipe");

          const metaEl = document.createElement("div");
          metaEl.className = "recipe-meta";
          metaEl.textContent = recipe.meta || "";

          card.appendChild(titleEl);
          card.appendChild(metaEl);

          card.addEventListener("click", () => {
            selectedId = recipe.id;
            renderRecipeList();
            renderRecipeDetail(recipe);
          });

          recipesListEl.appendChild(card);
        });
      });
    }

    function renderRecipeDetail(recipe) {
      if (!recipe) {
        detailBodyEl.innerHTML =
          '<div class="empty-state">Select a recipe on the left to see full ingredients, method, usage notes, and nutrition.</div>';
        return;
      }

      const isHighProtein =
        (recipe.nutrition_html || "").toLowerCase().includes("protein") ||
        (recipe.nutrition_mode === "auto" && recipe.ingredients_meta);

      const container = document.createElement("div");

      const header = document.createElement("div");
      header.className = "detail-header";

      const titleEl = document.createElement("div");
      titleEl.className = "detail-title";
      titleEl.textContent = recipe.title || "Untitled recipe";

      const metaEl = document.createElement("div");
      metaEl.className = "detail-meta";
      metaEl.textContent =
        (recipe.section ? recipe.section + " ¬∑ " : "") + (recipe.meta || "");

      const badgeRow = document.createElement("div");
      badgeRow.className = "detail-badge-row";

      if (recipe.section) {
        const b1 = document.createElement("span");
        b1.className = "badge";
        b1.textContent = recipe.section;
        badgeRow.appendChild(b1);
      }

      const b2 = document.createElement("span");
      b2.className = "badge";
      b2.textContent = "Vegetarian ¬∑ Gluten-Free";
      badgeRow.appendChild(b2);

      if (isHighProtein) {
        const b3 = document.createElement("span");
        b3.className = "badge";
        b3.textContent = "High-Protein";
        badgeRow.appendChild(b3);
      }

      const nameLower = (recipe.title || "").toLowerCase();
      const secLower = (recipe.section || "").toLowerCase();
      const typeBadge = document.createElement("span");
      typeBadge.className = "badge";

      if (secLower.includes("soup") || nameLower.includes("soup") || nameLower.includes("stew")) {
        typeBadge.classList.add("badge-type-soup");
        typeBadge.textContent = "ü•£ Soup / Stew";
      } else if (nameLower.includes("bowl")) {
        typeBadge.classList.add("badge-type-bowl");
        typeBadge.textContent = "üç≤ Bowl";
      } else if (nameLower.includes("skillet")) {
        typeBadge.classList.add("badge-type-skillet");
        typeBadge.textContent = "üç≥ Skillet";
      } else if (secLower.includes("dessert") || nameLower.includes("cake") || nameLower.includes("cookie")) {
        typeBadge.classList.add("badge-type-dessert");
        typeBadge.textContent = "üç∞ Dessert";
      } else {
        typeBadge.classList.add("badge-type-main");
        typeBadge.textContent = "üçΩ Main";
      }

      badgeRow.appendChild(typeBadge);

      header.appendChild(titleEl);
      header.appendChild(metaEl);
      header.appendChild(badgeRow);

      const detailSections = document.createElement("div");
      detailSections.className = "detail-sections";

      const leftCol = document.createElement("div");
      const rightCol = document.createElement("div");

      const ingBlock = document.createElement("div");
      ingBlock.className = "detail-block";
      ingBlock.innerHTML = recipe.ingredients_html || "<p>No ingredients listed.</p>";

      const methodBlock = document.createElement("div");
      methodBlock.className = "detail-block";
      methodBlock.innerHTML = recipe.method_html || "<p>No method provided.</p>";

      const usageBlock = document.createElement("div");
      usageBlock.className = "detail-block";
      usageBlock.innerHTML = recipe.usage_html || "<p>No usage notes yet.</p>";

      const nutritionBlock = document.createElement("div");
      nutritionBlock.className = "detail-block";

      let nutHtml = null;
      if (recipe.nutrition_mode === "auto" && recipe.ingredients_meta) {
        nutHtml = buildAutoNutritionHtml(recipe);
      }
      if (!nutHtml) {
        nutHtml = recipe.nutrition_html || "<p>No nutrition info available.</p>";
      }

      nutritionBlock.innerHTML =
        nutHtml +
        '<div class="nutrition-note">Nutrition is approximate and for guidance only.</div>';

      leftCol.appendChild(ingBlock);
      leftCol.appendChild(usageBlock);
      rightCol.appendChild(methodBlock);
      rightCol.appendChild(nutritionBlock);

      detailSections.appendChild(leftCol);
      detailSections.appendChild(rightCol);

      container.appendChild(header);
      container.appendChild(detailSections);

      detailBodyEl.innerHTML = "";
      detailBodyEl.appendChild(container);

      if (cookMode) {
        detailBodyEl.scrollTop = 0;
      }
    }

    cookModeToggle.addEventListener("click", () => {
      cookMode = !cookMode;
      cookModeToggle.classList.toggle("active", cookMode);
      cookModeToggle.textContent = cookMode ? "Cook Mode On" : "Cook Mode";
    });

    searchInput.addEventListener("input", () => {
      applyFilters();
    });

    sectionFilter.addEventListener("change", () => {
      applyFilters();
    });

    const importExistingEl = document.getElementById("importExisting");
    const importNewEl = document.getElementById("importNew");
    const importMergeBtn = document.getElementById("importMergeBtn");
    const importStatusEl = document.getElementById("importStatus");

    function mergeRecipeArraysById(existingArr, newArr) {
      if (!Array.isArray(existingArr)) {
        throw new Error("Existing file is not a JSON array.");
      }
      if (!Array.isArray(newArr)) {
        throw new Error("New file is not a JSON array.");
      }

      const byId = new Map();
      let added = 0;
      let replaced = 0;
      let skipped = 0;

      for (const r of existingArr) {
        if (!r || typeof r !== "object" || !r.id) {
          skipped++;
          continue;
        }
        byId.set(r.id, r);
      }

      for (const r of newArr) {
        if (!r || typeof r !== "object" || !r.id) {
          skipped++;
          continue;
        }
        if (byId.has(r.id)) {
          replaced++;
        } else {
          added++;
        }
        byId.set(r.id, r);
      }

      const merged = Array.from(byId.values());
      return { merged, added, replaced, skipped };
    }

    function downloadMergedRecipesFile(recipesArray) {
      const blob = new Blob([JSON.stringify(recipesArray, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "merged_recipes.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    if (importMergeBtn && importExistingEl && importNewEl && importStatusEl) {
      importMergeBtn.addEventListener("click", () => {
        const existingFile = importExistingEl.files && importExistingEl.files[0];
        const newFile = importNewEl.files && importNewEl.files[0];

        if (!existingFile || !newFile) {
          importStatusEl.textContent =
            "Select both files first: existing recipes.json and new recipes JSON.";
          importStatusEl.className = "importer-status error";
          return;
        }

        importStatusEl.textContent = "Reading files‚Ä¶";
        importStatusEl.className = "importer-status";

        const readerExisting = new FileReader();
        const readerNew = new FileReader();

        let existingData = null;
        let newData = null;

        function tryMerge() {
          if (!existingData || !newData) return;
          try {
            const parsedExisting = JSON.parse(existingData);
            const parsedNew = JSON.parse(newData);

            const { merged, added, replaced, skipped } =
              mergeRecipeArraysById(parsedExisting, parsedNew);

            downloadMergedRecipesFile(merged);

            importStatusEl.textContent =
              `Merged: ${merged.length} total ¬∑ ${replaced} replaced ¬∑ ${added} added ¬∑ ${skipped} skipped (invalid/missing id).`;
            importStatusEl.className = "importer-status success";
          } catch (err) {
            console.error(err);
            importStatusEl.textContent = "Merge failed: " + err.message;
            importStatusEl.className = "importer-status error";
          }
        }

        readerExisting.onload = (e) => {
          existingData = e.target.result;
          tryMerge();
        };
        readerNew.onload = (e) => {
          newData = e.target.result;
          tryMerge();
        };
        readerExisting.onerror = () => {
          importStatusEl.textContent = "Could not read existing file.";
          importStatusEl.className = "importer-status error";
        };
        readerNew.onerror = () => {
          importStatusEl.textContent = "Could not read new recipes file.";
          importStatusEl.className = "importer-status error";
        };

        readerExisting.readAsText(existingFile);
        readerNew.readAsText(newFile);
      });
    }

    let metaList = [];

    function addMetaEntry() {
      const id = document.getElementById("metaIngId").value;
      const grams = parseInt(document.getElementById("metaIngGrams").value, 10);
      if (!grams || grams < 1) return;

      metaList.push({ id, grams });
      renderMeta();
    }

    function renderMeta() {
      const out = document.getElementById("metaGenOutput");
      out.textContent =
`"nutrition_mode": "auto",
"ingredients_meta": [
` + metaList.map(m => `  { "id": "${m.id}", "grams": ${m.grams} }`).join(",\n") + `
]`;
    }

    function copyMetaOutput() {
      const text = document.getElementById("metaGenOutput").textContent;
      navigator.clipboard.writeText(text.trim());
    }

    function downloadCookbook() {
      const blob = new Blob([JSON.stringify(allRecipes, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "recipes.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    loadRecipes();
  </script>
</body>
</html>
