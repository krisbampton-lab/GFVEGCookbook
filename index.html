<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gluten-Free Vegetarian Cookbook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f7faf7;
      --bg-alt: #ffffff;
      --border: #d1e2d1;
      --accent: #2f7c4f;
      --accent-soft: #cfe8d7;
      --text: #1f2a1f;
      --muted: #5f6f5f;
      --card-shadow: 0 2px 6px rgba(0,0,0,0.06);
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 6px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 1rem 1.5rem;
      background: var(--bg-alt);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1.5rem;
      align-items: center;
      justify-content: space-between;
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .brand-title {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .brand-subtitle {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: flex-end;
    }

    .search-input {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.45rem 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg);
      min-width: 230px;
    }

    .search-input input {
      border: none;
      outline: none;
      background: transparent;
      font-size: 0.9rem;
      flex: 1;
    }

    select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.35rem 0.75rem;
      font-size: 0.9rem;
      background: var(--bg-alt);
      color: var(--text);
    }

    main {
      flex: 1;
      padding: 1.25rem 1.5rem 1rem;
    }

    .content-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.5fr);
      gap: 1rem;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .content-inner {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: var(--bg-alt);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
      padding: 0.9rem;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .panel-body {
      max-height: calc(100vh - 220px);
      overflow: auto;
      padding-right: 0.25rem;
    }

    @media (max-width: 900px) {
      .panel-body {
        max-height: none;
      }
    }

    .recipe-list {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .section-label {
      margin-top: 0.9rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      color: var(--muted);
    }

    .recipe-card {
      border-radius: var(--radius-md);
      border: 1px solid #e1efe4;
      background: #f9fcf9;
      padding: 0.45rem 0.6rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
    }

    .recipe-card:hover {
      background: #f2f8f3;
      border-color: var(--accent-soft);
      transform: translateY(-1px);
    }

    .recipe-card.selected {
      border-color: var(--accent);
      background: #edf7ef;
    }

    .recipe-title {
      font-size: 0.92rem;
      font-weight: 600;
      color: var(--text);
    }

    .recipe-meta {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .detail-header {
      margin-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.4rem;
    }

    .detail-title {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 0.1rem;
    }

    .detail-meta {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.15rem;
    }

    .detail-badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      font-size: 0.7rem;
    }

    .badge {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      color: var(--accent);
      background: #f3fbf5;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
    }

    .cook-mode-toggle {
      font-size: 0.75rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f6faf7;
      padding: 0.2rem 0.6rem;
      cursor: pointer;
    }

    .cook-mode-toggle.active {
      border-color: var(--accent);
      background: #e4f5e8;
      color: var(--accent);
    }

    .detail-sections {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
      gap: 0.75rem;
    }

    @media (max-width: 900px) {
      .detail-sections {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .detail-block {
      border-radius: var(--radius-md);
      background: #f9fcf9;
      border: 1px solid #e0eee2;
      padding: 0.6rem 0.7rem;
      font-size: 0.87rem;
    }

    .detail-block h4 {
      margin: 0 0 0.35rem;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    .detail-block ul {
      margin: 0.2rem 0 0 1.2rem;
      padding: 0;
    }

    .detail-block li {
      margin-bottom: 0.15rem;
    }

    .detail-block ol {
      margin: 0.2rem 0 0 1.2rem;
      padding: 0;
    }

    .detail-block p {
      margin: 0.2rem 0;
    }

    .nutrition-note {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 0.45rem;
    }

    .empty-state {
      font-size: 0.85rem;
      color: var(--muted);
      padding: 0.75rem 0.25rem;
    }

    .error-state {
      font-size: 0.85rem;
      color: #b03030;
      padding: 0.75rem 0.25rem;
    }

    /* Importer footer ‚Äì small, out of the way */

    .importer-footer {
      border-top: 1px solid var(--border);
      padding: 0.5rem 1.5rem 1rem;
      background: #f5f8f6;
    }

    .importer-inner {
      max-width: 1200px;
      margin: 0 auto;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .importer-details {
      border-radius: var(--radius-md);
      border: 1px dashed var(--border);
      padding: 0.35rem 0.6rem 0.5rem;
      background: #f8fbf8;
    }

    .importer-details summary {
      cursor: pointer;
      list-style: none;
      font-weight: 500;
      color: #708270;
    }

    .importer-details summary::marker {
      display: none;
    }

    .importer-details summary::-webkit-details-marker {
      display: none;
    }

    .importer-details summary span {
      font-size: 0.75rem;
    }

    .importer-body {
      margin-top: 0.4rem;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 0.6rem;
    }

    @media (max-width: 800px) {
      .importer-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .importer-col label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.76rem;
    }

    .importer-col input[type="file"] {
      font-size: 0.75rem;
      width: 100%;
    }

    .importer-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      margin-top: 0.35rem;
    }

    .importer-btn {
      font-size: 0.76rem;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: #e5f5eb;
      color: var(--accent);
      padding: 0.25rem 0.7rem;
      cursor: pointer;
    }

    .importer-status {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .importer-status.error {
      color: #b03030;
    }

    .importer-status.success {
      color: #2f7c4f;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="header-inner">
        <div class="brand-block">
          <div class="brand-title">GF Veg Cookbook</div>
          <div class="brand-subtitle">
            High-protein, gluten-free vegetarian recipes ‚Äì powered by your JSON.
          </div>
        </div>
        <div class="controls-row">
          <div class="search-input">
            <span>üîç</span>
            <input id="searchInput" type="search" placeholder="Search recipes, ingredients, notes‚Ä¶" />
          </div>
          <select id="sectionFilter">
            <option value="">All sections</option>
          </select>
        </div>
      </div>
    </header>

    <main>
      <div class="content-inner">
        <!-- LEFT: recipe list -->
        <section class="panel">
          <div class="panel-header">
            <div class="panel-title">Recipes</div>
            <div id="resultCount" class="panel-title" style="opacity:0.7;"></div>
          </div>
          <div class="panel-body">
            <div id="recipesList" class="recipe-list"></div>
            <div id="listMessage" class="empty-state" style="display:none;"></div>
          </div>
        </section>

        <!-- RIGHT: recipe detail -->
        <section class="panel">
          <div class="panel-header">
            <div class="panel-title">Details</div>
            <button id="cookModeToggle" class="cook-mode-toggle" type="button">
              Cook Mode
            </button>
          </div>
          <div class="panel-body" id="detailBody">
            <div class="empty-state">
              Select a recipe on the left to see full ingredients, method, usage notes, and nutrition.
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Small, out-of-the-way bulk importer -->
    <footer class="importer-footer">
      <div class="importer-inner">
        <details class="importer-details">
          <summary>
            <span>Advanced: Bulk importer (merge two recipe JSON files and download a combined file)</span>
          </summary>
          <div class="importer-body">
            <div class="importer-col">
              <label for="importExisting"><strong>1.</strong> Existing cookbook JSON (your current <code>recipes.json</code>)</label>
              <input id="importExisting" type="file" accept="application/json" />
            </div>
            <div class="importer-col">
              <label for="importNew"><strong>2.</strong> New recipes JSON (extra recipes I generate for you)</label>
              <input id="importNew" type="file" accept="application/json" />
            </div>
          </div>
          <div class="importer-actions">
            <button type="button" class="importer-btn" id="importMergeBtn">
              Merge &amp; Download merged_recipes.json
            </button>
            <div id="importStatus" class="importer-status">
              Tip: this never changes your live site automatically ‚Äì it just gives you a merged file to upload as your new <code>recipes.json</code>.
            </div>
          </div>
        </details>
      </div>
    </footer>
  </div>

  <script>
    const RECIPES_JSON_URL = "recipes.json";

    let allRecipes = [];
    let filteredRecipes = [];
    let selectedId = null;
    let cookMode = false;

    const searchInput = document.getElementById("searchInput");
    const sectionFilter = document.getElementById("sectionFilter");
    const recipesListEl = document.getElementById("recipesList");
    const listMessageEl = document.getElementById("listMessage");
    const detailBodyEl = document.getElementById("detailBody");
    const resultCountEl = document.getElementById("resultCount");
    const cookModeToggle = document.getElementById("cookModeToggle");

    async function loadRecipes() {
      try {
        const res = await fetch(RECIPES_JSON_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Network error loading recipes.json");
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("recipes.json is not an array");
        allRecipes = data;
        buildSectionFilter(allRecipes);
        filteredRecipes = [...allRecipes];
        renderRecipeList();
        updateResultCount();
      } catch (err) {
        console.error(err);
        recipesListEl.innerHTML = "";
        listMessageEl.style.display = "block";
        listMessageEl.className = "error-state";
        listMessageEl.textContent =
          "Could not load recipes.json. Check that the file exists next to index.html.";
      }
    }

    function buildSectionFilter(recipes) {
      const sections = Array.from(new Set(recipes.map(r => r.section || "")))
        .filter(Boolean)
        .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: "base" }));
      sectionFilter.innerHTML = '<option value="">All sections</option>';
      sections.forEach(sec => {
        const opt = document.createElement("option");
        opt.value = sec;
        opt.textContent = sec;
        sectionFilter.appendChild(opt);
      });
    }

    function applyFilters() {
      const term = searchInput.value.trim().toLowerCase();
      const section = sectionFilter.value;

      filteredRecipes = allRecipes.filter(r => {
        if (section && r.section !== section) return false;
        if (!term) return true;
        const haystack =
          (r.title || "") +
          " " +
          (r.section || "") +
          " " +
          (r.meta || "") +
          " " +
          (r.ingredients_html || "") +
          " " +
          (r.usage_html || "");
        return haystack.toLowerCase().includes(term);
      });

      if (selectedId && !filteredRecipes.some(r => r.id === selectedId)) {
        selectedId = null;
        renderRecipeDetail(null);
      }

      renderRecipeList();
      updateResultCount();
    }

    function updateResultCount() {
      const total = allRecipes.length;
      const shown = filteredRecipes.length;
      if (!total) {
        resultCountEl.textContent = "";
        return;
      }
      resultCountEl.textContent = `${shown} of ${total}`;
    }

    function renderRecipeList() {
      recipesListEl.innerHTML = "";
      listMessageEl.style.display = "none";

      if (!filteredRecipes.length) {
        listMessageEl.style.display = "block";
        listMessageEl.className = "empty-state";
        listMessageEl.textContent = "No recipes match your search or filters.";
        return;
      }

      const bySection = {};
      filteredRecipes.forEach(r => {
        const sec = r.section || "Uncategorized";
        if (!bySection[sec]) bySection[sec] = [];
        bySection[sec].push(r);
      });

      const sectionNames = Object.keys(bySection).sort((a, b) =>
        a.localeCompare(b, undefined, { sensitivity: "base" })
      );

      sectionNames.forEach(sec => {
        const label = document.createElement("div");
        label.className = "section-label";
        label.textContent = sec;
        recipesListEl.appendChild(label);

        bySection[sec].forEach(recipe => {
          const card = document.createElement("div");
          card.className =
            "recipe-card" + (recipe.id === selectedId ? " selected" : "");
          card.dataset.id = recipe.id;

          const titleEl = document.createElement("div");
          titleEl.className = "recipe-title";
          titleEl.textContent = recipe.title || "Untitled recipe";

          const metaEl = document.createElement("div");
          metaEl.className = "recipe-meta";
          metaEl.textContent = recipe.meta || "";

          card.appendChild(titleEl);
          card.appendChild(metaEl);

          card.addEventListener("click", () => {
            selectedId = recipe.id;
            renderRecipeList();
            renderRecipeDetail(recipe);
          });

          recipesListEl.appendChild(card);
        });
      });
    }

    function renderRecipeDetail(recipe) {
      if (!recipe) {
        detailBodyEl.innerHTML =
          '<div class="empty-state">Select a recipe on the left to see full ingredients, method, usage notes, and nutrition.</div>';
        return;
      }

      const isHighProtein =
        (recipe.nutrition_html || "").toLowerCase().includes("protein");

      const container = document.createElement("div");

      const header = document.createElement("div");
      header.className = "detail-header";

      const titleEl = document.createElement("div");
      titleEl.className = "detail-title";
      titleEl.textContent = recipe.title || "Untitled recipe";

      const metaEl = document.createElement("div");
      metaEl.className = "detail-meta";
      metaEl.textContent =
        (recipe.section ? recipe.section + " ¬∑ " : "") + (recipe.meta || "");

      const badgeRow = document.createElement("div");
      badgeRow.className = "detail-badge-row";

      if (recipe.section) {
        const b1 = document.createElement("span");
        b1.className = "badge";
        b1.textContent = recipe.section;
        badgeRow.appendChild(b1);
      }

      const b2 = document.createElement("span");
      b2.className = "badge";
      b2.textContent = "Vegetarian ¬∑ Gluten-Free";
      badgeRow.appendChild(b2);

      if (isHighProtein) {
        const b3 = document.createElement("span");
        b3.className = "badge";
        b3.textContent = "High-Protein";
        badgeRow.appendChild(b3);
      }

      header.appendChild(titleEl);
      header.appendChild(metaEl);
      header.appendChild(badgeRow);

      const detailSections = document.createElement("div");
      detailSections.className = "detail-sections";

      const leftCol = document.createElement("div");
      const rightCol = document.createElement("div");

      const ingBlock = document.createElement("div");
      ingBlock.className = "detail-block";
      ingBlock.innerHTML = recipe.ingredients_html || "<p>No ingredients listed.</p>";

      const methodBlock = document.createElement("div");
      methodBlock.className = "detail-block";
      methodBlock.innerHTML = recipe.method_html || "<p>No method provided.</p>";

      const usageBlock = document.createElement("div");
      usageBlock.className = "detail-block";
      usageBlock.innerHTML = recipe.usage_html || "<p>No usage notes yet.</p>";

      const nutritionBlock = document.createElement("div");
      nutritionBlock.className = "detail-block";
      nutritionBlock.innerHTML =
        (recipe.nutrition_html || "<p>No nutrition info available.</p>") +
        '<div class="nutrition-note">Nutrition is approximate and for guidance only.</div>';

      leftCol.appendChild(ingBlock);
      leftCol.appendChild(usageBlock);
      rightCol.appendChild(methodBlock);
      rightCol.appendChild(nutritionBlock);

      detailSections.appendChild(leftCol);
      detailSections.appendChild(rightCol);

      container.appendChild(header);
      container.appendChild(detailSections);

      detailBodyEl.innerHTML = "";
      detailBodyEl.appendChild(container);

      if (cookMode) {
        detailBodyEl.scrollTop = 0;
      }
    }

    cookModeToggle.addEventListener("click", () => {
      cookMode = !cookMode;
      cookModeToggle.classList.toggle("active", cookMode);
      cookModeToggle.textContent = cookMode ? "Cook Mode On" : "Cook Mode";
    });

    searchInput.addEventListener("input", () => {
      applyFilters();
    });

    sectionFilter.addEventListener("change", () => {
      applyFilters();
    });

    loadRecipes();

    // --- Bulk importer logic (small, advanced, file-based) ---

    const importExistingInput = document.getElementById("importExisting");
    const importNewInput = document.getElementById("importNew");
    const importMergeBtn = document.getElementById("importMergeBtn");
    const importStatus = document.getElementById("importStatus");

    function readJsonFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error("File read error"));
        reader.onload = () => {
          try {
            const json = JSON.parse(reader.result);
            if (!Array.isArray(json)) {
              reject(new Error("JSON file must contain an array of recipes."));
            } else {
              resolve(json);
            }
          } catch (e) {
            reject(new Error("Invalid JSON file."));
          }
        };
        reader.readAsText(file);
      });
    }

    function mergeRecipes(existing, incoming) {
      const map = new Map();
      existing.forEach(r => {
        if (r && r.id) {
          map.set(r.id, r);
        }
      });

      incoming.forEach(r => {
        if (!r || !r.id) return;
        let baseId = r.id;
        let newId = baseId;
        let counter = 2;
        while (map.has(newId)) {
          newId = baseId + "-" + counter;
          counter++;
        }
        r.id = newId;
        map.set(newId, r);
      });

      return Array.from(map.values());
    }

    importMergeBtn.addEventListener("click", async () => {
      importStatus.className = "importer-status";
      importStatus.textContent = "Reading files‚Ä¶";

      const existingFile = importExistingInput.files[0];
      const newFile = importNewInput.files[0];

      if (!existingFile || !newFile) {
        importStatus.className = "importer-status error";
        importStatus.textContent = "Please select both the existing cookbook JSON and the new recipes JSON.";
        return;
      }

      try {
        const [existingArr, newArr] = await Promise.all([
          readJsonFile(existingFile),
          readJsonFile(newFile)
        ]);

        const merged = mergeRecipes(existingArr, newArr);

        const blob = new Blob([JSON.stringify(merged, null, 2)], {
          type: "application/json"
        });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "recipes_merged.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        importStatus.className = "importer-status success";
        importStatus.textContent =
          `Merged ${existingArr.length} + ${newArr.length} recipes ‚Üí ${merged.length} total. Downloaded as recipes_merged.json ‚Äì upload that as your new recipes.json.`;
      } catch (err) {
        console.error(err);
        importStatus.className = "importer-status error";
        importStatus.textContent = err.message || "Something went wrong merging the files.";
      }
    });
  </script>
</body>
</html>
